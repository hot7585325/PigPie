<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Three.js GLTFLoader Example</title>
  <style>
    body {
      margin: 0;
      overflow: hidden;
      background-color: rgba(255, 201, 101, 0.986);
    }

    canvas {
      display: block;
    }

    #MobilePanel {
      position: fixed;
      pointer-events: none;
      width: 100vw;
      height: 100vh;
      background-color: rgba(255, 255, 255, 0);
    }

    #TitlePanel {
      position: absolute;
      width: 100vw;
      height: 15vh;
      top: 0%;
      background-color: black;
      text-align: center;
      font-size: 2em;
      color: white;
    }

    #ButtonPanel {
      position: absolute;
      display: flex;
      justify-content: center;
      /* 水平置中 */
      align-items: center;
      /* 垂直置中 */
      gap: 5%;
      width: 100vw;
      height: 15vh;
      bottom: 10%;
      background-color: rgba(250, 0, 0, 0.616);

    }

    #ButtonPanel button {
      pointer-events: auto;
      text-align: center;
      width: 20%;
      height: auto;
      font-size: 3em;
    }
  </style>
  <!-- 網頁用Console -->
  <!-- <script src="https://cdn.bootcdn.net/ajax/libs/vConsole/3.15.0/vconsole.min.js"></script>
  <script>  var vConsole = new VConsole();  </script> -->

  <!-- GLTFLoader中的import有使用 from 'three';，如果不用importmap會導致找不到模組 -->
  <script type="importmap">
{
  "imports": {
    "three": "https://cdn.jsdelivr.net/npm/three@0.180.0/build/three.module.js"
  }
}
</script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
</head>




<body>
  <div id="MobilePanel">

    <div id="TitlePanel">
      <h1>丘山的工作日常<br>煎</h1>
    </div>


    <div id="ButtonPanel">
      <button id="big_fire"> 大火</button>
      <button id="small_fire"> 小火</button>
      <button id="turn"> 翻面</button>
    </div>
  </div>

  <script type="module">
    // cdn方式(官方)
    import * as THREE from 'three';
    import { OrbitControls } from "https://cdn.jsdelivr.net/npm/three@0.180.0/examples/jsm/controls/OrbitControls.js";
    import { GLTFLoader } from 'https://cdn.jsdelivr.net/npm/three@0.180.0/examples/jsm/loaders/GLTFLoader.js';
    import { AnimationMixer } from 'three';
    // 建立場景
    const scene = new THREE.Scene();
    // scene.background = new THREE.Color(255, 0, 0);

    //動畫用
    const clock = new THREE.Clock();
    const mixers = [];   //陣列存取動畫
    const actions = [];
    let placedMesh = new THREE.Group();  //空物件 手勢控制用
    let FireAni = null;
    let PieAni = null;
    let IsPlay_Ani_Pie = false;

    // 相機
    const camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
    camera.position.set(0, 5, 5);

    // 渲染器
    const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
    renderer.setClearColor(0x000000, 0); // 第二個參數是 alpha，0 表示完全透明
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.body.appendChild(renderer.domElement);

    // 光源
    const hemiLight = new THREE.HemisphereLight(0xffffff, 0x444444, 1);
    hemiLight.position.set(0, 20, 0);
    scene.add(hemiLight);

    const dirLight = new THREE.DirectionalLight(0xffffff, 1);
    dirLight.position.set(5, 10, 7.5);
    scene.add(dirLight);

    const FireLight = new THREE.DirectionalLight(0xffffff, 2);
    FireLight.position.set(0, -1, 0);
    scene.add(FireLight);

    // 載入模型
    const loader = new GLTFLoader();

    // 控制器
    const controls = new OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;



    function Main() {

      placedMesh.position.set(0, 0, 0);
      scene.add(placedMesh);

      //餡餅
      loader.load(
        "Model/Pie.glb",
        (gltf) => {
          PieAni = Set_Model_Attribute(gltf);

        },
        (xhr) => {
          console.log((xhr.loaded / xhr.total * 100) + "% loaded");
        },
        (error) => {
          console.error("載入失敗：", error);
        }
      );

      //鍋子+火
      loader.load(

        "Model/Pot.glb",
        (gltf) => {
          FireAni = Set_Model_Attribute(gltf);

        },
        (xhr) => {
          console.log((xhr.loaded / xhr.total * 100) + "% loaded");
        },
        (error) => {
          console.error("載入失敗：", error);
        }
      );



      // 視窗大小自適應
      window.addEventListener("resize", () => {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
      });

    }


    function DOMCtrl() {
      //dom賦值
      const big_fire = document.getElementById("big_fire")
      const small_fire = document.getElementById("small_fire")
      const turn = document.getElementById("turn")

      big_fire.addEventListener("click", () => { FireAni.play(); })
      small_fire.addEventListener("click", () => { GSAP_toggleBounce("big_fire", true) })
      turn.addEventListener("click", () => {
        IsPlay_Ani_Pie = !IsPlay_Ani_Pie;
        if (IsPlay_Ani_Pie) {
          PieAni.play();
        } else {  
          PieAni.stop();
        }

      })

    }


    function GSAP_toggleBounce(id, show) {
      const el = document.getElementById(id);
      if (!el) return;

      if (show) {
        // 顯示並彈跳出現
        el.style.display = "block";
        gsap.fromTo(el,
          { scale: 0, y: 50, opacity: 0 },
          {
            scale: 1,
            y: 0,
            opacity: 1,
            duration: 0.6,
            ease: "bounce.out"
          }
        );
      } else {
        // 縮小並消失
        gsap.to(el, {
          scale: 0,
          y: 50,
          opacity: 0,
          duration: 0.4,
          ease: "power2.in",
          onComplete: () => {
            el.style.display = "none";
          }
        });
      }
    }

    //設定model相關參數(不需要使用 scene.add(_model)，因為作為容器的placedMesh已經實作了)
    function Set_Model_Attribute(gltf, AniIndex = 0) {

      const _model = gltf.scene;
      //加到以實作scene.add，的容器中
      placedMesh.add(_model);

      //轉換
      _model.position.set(0, 0, 0); // 相對於 placedMesh 的位置
      _model.quaternion.identity(); // 清除旋轉（可選）
      _model.scale.setScalar(0.5);  // 設定縮放


      //動畫
      const _mixer = new AnimationMixer(_model);
      const clip = gltf.animations[AniIndex];
      const _action = _mixer.clipAction(clip);
      // 儲存到陣列
      mixers.push(_mixer);
      actions.push(_action);

      return _action;
    }

    // 動畫迴圈
    function animate() {
      requestAnimationFrame(animate);
      controls.update();
      // 更新動畫時間軸
      const delta = clock.getDelta();
      mixers.forEach(mixer => mixer.update(delta));
      renderer.render(scene, camera);
    }


    Main();
    DOMCtrl();
    animate();

  </script>
</body>

</html>